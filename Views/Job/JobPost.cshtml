@model JobViewModel
@{
	ViewBag.Title = "Job Posting";
	Layout = "~/Views/Shared/_EmployeeLayout.cshtml";
}

@if (TempData["SuccessMessage"] != null)
{
	<div class="success-toast">
		<div class="success-card">
			<div class="icon">✔️</div>
			<h2>Success!</h2>
			<p>@TempData["SuccessMessage"]</p>
		</div>
	</div>

	<script>
		// Close modal if it exists
		document.addEventListener("DOMContentLoaded", function() {
			const modal = document.querySelector(".modal");
			if (modal) {
				modal.style.display = "none";
			}
		});
	</script>
}

@if (TempData["ErrorMessage"] != null)
{
	<div id="errorBox"
		 style="display: block; background: rgba(0,0,0,0.6);
	                         position: fixed; inset: 0; z-index: 9999;
	                         display: flex; justify-content: center; align-items: center;">

		<div style="background: #f87171; color: white; border-radius: 12px;
	                             padding: 25px 30px; text-align: center; width: 320px;
	                             box-shadow: 0 8px 30px rgba(0,0,0,0.25);
	                             animation: popIn 0.3s ease-out;">

			<div style="font-size: 50px; margin-bottom: 15px;">😟</div>
			<h2 style="margin: 0 0 10px; font-size: 1.5rem;">
				@(TempData["ErrorTitle"] ?? "Oops!")
			</h2>
			<p style="font-size: 0.95rem; margin-bottom: 20px;">
				@TempData["ErrorMessage"]
			</p>

			<button onclick="document.getElementById('errorBox').style.display='none'"
					style="background: white; color: #b91c1c; border: none;
	                                    padding: 10px 25px; border-radius: 50px;
	                                    font-size: 1rem; cursor: pointer;">
				OK
			</button>
		</div>
	</div>
}


<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<link rel="stylesheet" href="~/css/jobForm.css">

<div class="job-card @(ViewData.ModelState.ErrorCount > 0 ? "error" : "")">
	<form asp-action="JobPost" method="post" class="form" id="jobForm">
		<div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

		<!-- Title -->
		<div class="form-group">
			<label asp-for="Title" class="required"></label>
			<input asp-for="Title" class="form-control" id="Title" maxlength="120" autofocus />
			<small id="title-counter" class="text-muted"></small>
			<span asp-validation-for="Title" class="invalid-feedback"></span>
		</div>

		<!-- Description -->
		<div class="form-group">
			<label asp-for="Description" class="required"></label>
			<textarea asp-for="Description" class="form-control" rows="5"></textarea>
			<span asp-validation-for="Description" class="invalid-feedback"></span>
		</div>

		<!-- Location -->
		<div class="form-group position-relative">
			<label asp-for="Location" class="required"></label>
			<input asp-for="Location" class="form-control" id="location-input" autocomplete="off" />
			<div id="suggestions"></div>
			<small class="form-text text-muted">Search for location or click on the map</small>
			<span asp-validation-for="Location" class="invalid-feedback"></span>
		</div>

		<!-- Hidden inputs for coordinates -->
		<input asp-for="Latitude" type="hidden" id="latitude-input" />
		<input asp-for="Longitude" type="hidden" id="longitude-input" />

		<!-- Map -->
		<div class="form-group">
			<div id="map" style="height: 400px; border: 1px solid #ccc;"></div>
		</div>

		<!-- Salary Fields -->
		<div class="row">
			<div class="col-md-6">
				<div class="form-group">
					<label asp-for="MinSalary" class="required"></label>
					<div class="input-group has-validation">
						<span class="input-group-text">RM</span>
						<input asp-for="MinSalary" class="form-control" type="number" step="0.01" min="0" />
						<span asp-validation-for="MinSalary" class="invalid-feedback"></span>
					</div>
				</div>
			</div>
			<div class="col-md-6">
				<div class="form-group">
					<label asp-for="MaxSalary" class="required"></label>
					<div class="input-group has-validation">
						<span class="input-group-text">RM</span>
						<input asp-for="MaxSalary" class="form-control" type="number" step="0.01" min="0" />
						<span asp-validation-for="MaxSalary" class="invalid-feedback"></span>
					</div>
				</div>
			</div>
		</div>

		<!-- Dropdowns -->
		<div class="row">
			<div class="col-md-4">
				<div class="form-group">
					<label asp-for="JobType" class="required"></label>
					<select asp-for="JobType" asp-items="Model.JobTypes" class="form-select">
						<option value="">-- Select Job Type --</option>
					</select>
					<span asp-validation-for="JobType" class="invalid-feedback"></span>
				</div>
			</div>
			<div class="col-md-4">
				<div class="form-group">
					<label asp-for="Status" class="required"></label>
					<select asp-for="Status" asp-items="Model.StatusOptions" class="form-select">
						<option value="">-- Select Status --</option>
					</select>
					<span asp-validation-for="Status" class="invalid-feedback"></span>
				</div>
			</div>
			<div class="col-md-4">
				<div class="form-group">
					<label asp-for="CategoryId" class="required"></label>
					<select asp-for="CategoryId" asp-items="Model.Categories" class="form-select">
						<option value="">-- Select Category --</option>
					</select>
					<span asp-validation-for="CategoryId" class="invalid-feedback"></span>
				</div>
			</div>
		</div>

		<!-- Closing Date -->
		<div class="form-group">
			<label asp-for="ClosingDate"></label>
			<input asp-for="ClosingDate" class="form-control" type="date" min="@DateTime.Today.ToString("yyyy-MM-dd")" />
		</div>

		<input asp-for="EmployerId" type="hidden" />

		<!-- Form Actions -->
		<div class="button-group">
			<button type="submit" class="btn btn-primary">Submit</button>
			<button type="button" id="customReset" class="btn btn-reset">Reset</button>
		</div>

	</form>
</div>


@section Scripts {
	<script src="~/js/JobPostFormValidation.js"></script>
	<script src="~/js/map.js"></script>

	<script>
		// Backup reset functionality in case the main JS file doesn't work
		document.addEventListener('DOMContentLoaded', function() {
			const resetButton = document.getElementById('customReset');
			const form = document.getElementById('jobForm');
			const titleInput = document.getElementById('Title');
			const titleCounter = document.getElementById('title-counter');

			if (resetButton) {
				resetButton.addEventListener('click', function(e) {
					e.preventDefault();
					console.log('Backup reset functionality triggered');

					// Reset form values
					if (form) form.reset();

					// Clear validation errors
					document.querySelectorAll('.is-invalid, .input-validation-error').forEach(el => {
						el.classList.remove('is-invalid', 'input-validation-error');
					});

					document.querySelectorAll('.field-validation-error, .invalid-feedback').forEach(el => {
						el.textContent = '';
					});

					// Hide validation summaries
					document.querySelectorAll('.validation-summary-errors, .alert-danger').forEach(el => {
						el.style.display = 'none';
					});

					// Reset character counter
					if (titleCounter) {
						const charCount = titleInput ? titleInput.value.length : 0;
						titleCounter.textContent = `${charCount}/120 characters`;
						titleCounter.className = 'text-muted';
					}

					// Focus on title
					if (titleInput) {
						setTimeout(() => {
							titleInput.focus();
							titleInput.select();
						}, 100);
					}
				});
			}
		});
	</script>
}
