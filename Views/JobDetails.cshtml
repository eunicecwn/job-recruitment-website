@model JobRecruitment.Models.Job
@using System.Globalization
@using System.Security.Claims
@inject JobRecruitment.Models.DB Db

@{
    ViewData["Title"] = "Job Details";
    Layout = "~/Views/Shared/_Layout.cshtml";

    string Money(decimal v) => v.ToString("N0", CultureInfo.InvariantCulture);

    var isAuth = User?.Identity?.IsAuthenticated == true;
    bool alreadySaved = false;
    if (isAuth)
    {
        var uid = User.FindFirstValue(ClaimTypes.NameIdentifier);
        if (!string.IsNullOrWhiteSpace(uid))
            alreadySaved = Db.SavedJobs.Any(s => s.JobSeekerId == uid && s.JobId == Model.Id);
    }
}

<style>
    :root {
        --brand: var(--primary, #5b5bd6);
        --brand-600: var(--primary-dark, #4a4ac6);
        --brand-dark: var(--primary-dark, #3b3bb6);
        --chip-bg: #f8f9ff;
        --chip-border: #e8eafd;
    }

    .jobd-card {
        border: 2px solid var(--brand-dark);
        border-radius: 18px;
        box-shadow: 0 2px 10px rgba(25,35,70,.06);
        overflow: hidden;
        background: #fff
    }

    .jobd-header {
        padding: 18px 20px 14px;
        background: radial-gradient(1200px 160px at -200px -80px, rgba(91,91,214,.08), transparent),radial-gradient(800px 120px at 110% -40px, rgba(91,91,214,.06), transparent);
        border-bottom: 1px solid #eef0ff
    }

    .jobd-title {
        color: var(--brand);
        font-weight: 800;
        letter-spacing: .2px;
        margin-bottom: .25rem
    }

    .jobd-meta {
        display: grid;
        grid-template-columns: 1fr;
        gap: 6px;
        color: #4b5563;
        font-size: .975rem
    }

        .jobd-meta i {
            color: #6b72cf
        }

    .jobd-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px
    }

    .chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        background: var(--chip-bg);
        border: 1px solid var(--chip-border);
        color: #3f4370;
        font-weight: 600;
        font-size: .85rem
    }

    .jobd-actions {
        display: flex;
        gap: .5rem;
        flex-wrap: wrap
    }

        .jobd-actions .btn-primary {
            --bs-btn-bg: var(--brand);
            --bs-btn-border-color: var(--brand);
            --bs-btn-hover-bg: var(--brand-600);
            --bs-btn-hover-border-color: var(--brand-600)
        }

        .jobd-actions .btn-outline-primary {
            --bs-btn-color: var(--brand);
            --bs-btn-border-color: var(--brand);
            --bs-btn-hover-color: var(--brand);
            --bs-btn-hover-bg: rgba(var(--bs-primary-rgb),.08);
            --bs-btn-hover-border-color: var(--brand-600)
        }

        .jobd-actions .btn-outline-danger {
            --bs-btn-hover-bg: rgba(220,53,69,.08);
            --bs-btn-hover-color: #dc3545
        }

        .jobd-actions .btn {
            transition: transform .2s ease,box-shadow .2s ease
        }

            .jobd-actions .btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 6px 14px rgba(0,0,0,.08)
            }

    .jobd-section {
        padding: 16px 20px
    }

        .jobd-section + .jobd-section {
            border-top: 1px solid #f1f3ff
        }

    .jobd-facts {
        display: grid;
        gap: 10px;
        font-size: .975rem
    }

    .jobd-fact {
        display: flex;
        align-items: flex-start;
        gap: 10px
    }

        .jobd-fact i {
            color: #6b72cf;
            margin-top: 2px
        }

    .jobd-pane {
        border: 1px solid #eef0ff;
        border-radius: 14px;
        padding: 12px 14px;
        background: #fafbff
    }

    .btn-outline-success.brand-green {
        --bs-btn-color: #16a34a;
        --bs-btn-border-color: #16a34a;
        --bs-btn-hover-color: #fff;
        --bs-btn-hover-bg: #16a34a;
        --bs-btn-hover-border-color: #16a34a;
        --bs-btn-focus-shadow-rgb: 22,163,74;
        border-radius: 10px;
        font-weight: 600
    }

    @@media (min-width: 992px) {
        .jobd-header-grid {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            align-items: center
        }

        .jobd-meta {
            grid-template-columns: 1fr
        }
    }
</style>

<div class="container-xxl py-3">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a asp-controller="JobSearch" asp-action="Index">Jobs</a></li>
            <li class="breadcrumb-item active" aria-current="page">@Model.Title</li>
        </ol>
    </nav>

    <div class="jobd-card">
        <div class="jobd-header">
            <div class="jobd-header-grid">
                <div>
                    <h1 class="h4 jobd-title mb-1">@Model.Title</h1>

                    <div class="jobd-meta">
                        <div><i class="bi bi-building me-2"></i>@(Model.Employer?.CompanyName ?? "Unknown company")</div>
                        <div><i class="bi bi-geo-alt me-2"></i>@Model.Location</div>
                        <div><i class="bi bi-cash-coin me-2"></i> RM @Money(Model.MinSalary) – RM @Money(Model.MaxSalary)</div>

                        <div class="jobd-chips">
                            @if (!string.IsNullOrWhiteSpace(Model.Category?.Name))
                            {
                                <span class="chip"><i class="bi bi-tag"></i>@Model.Category.Name</span>
                            }
                            <span class="chip"><i class="bi bi-briefcase"></i>@Model.JobType</span>
                            <span class="chip">
                                <i class="bi bi-calendar-event"></i>
                                Posted @Model.PostedDate.ToLocalTime().ToString("dd MMM yyyy")
                                @if (Model.ClosingDate.HasValue)
                                {
                                    <text> • Closes @Model.ClosingDate.Value.ToLocalTime().ToString("dd MMM yyyy")</text>
                                }
                            </span>
                            <span class="chip"><i class="bi bi-check-circle"></i>@Model.Status</span>
                        </div>
                    </div>
                </div>

                <div class="jobd-actions text-nowrap">
                    <button type="button" class="btn btn-primary" id="btnOpenApply" data-jobid="@Model.Id"
                            data-bs-toggle="modal" data-bs-target="#applyModal">
                        Apply Now
                    </button>

                    @* Save / Saved *@
                    @if (isAuth)
                    {
                        <form method="post" asp-controller="JobSeekerActions" asp-action="SaveJob"
                              class="d-inline @(alreadySaved ? "d-none" : "")" id="saveForm">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="jobId" value="@Model.Id" />
                            <button type="submit" class="btn btn-outline-primary" id="btnSaveJob">
                                <i class="bi bi-bookmark"></i> Save
                            </button>
                        </form>

                        <form method="post" asp-controller="JobSeekerActions" asp-action="UnsaveJob"
                              class="d-inline @(alreadySaved ? "" : "d-none")" id="unsaveForm">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="jobId" value="@Model.Id" />
                            <button type="submit" class="btn btn-outline-secondary" id="btnUnsaveJob">
                                <i class="bi bi-bookmark-check"></i> Saved
                            </button>
                        </form>

                        <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#reportJobModal">Report</button>
                    }
                    else
                    {
                        <a class="btn btn-outline-primary"
                           asp-controller="Account" asp-action="Login"
                           asp-route-returnUrl="@(Context.Request.Path + Context.Request.QueryString)">
                            <i class="bi bi-bookmark"></i> Save
                        </a>
                        <a class="btn btn-outline-danger"
                           asp-controller="Account" asp-action="Login"
                           asp-route-returnUrl="@(Context.Request.Path + Context.Request.QueryString)">Report</a>
                    }

                    <a class="btn btn-outline-secondary" asp-controller="JobSearch" asp-action="Index">Back</a>
                </div>
            </div>
        </div>

        <div class="jobd-section">
            <h5 class="mb-2">Job Description</h5>
            <div class="mb-0" style="white-space:pre-wrap">@Model.Description</div>
        </div>

        <div class="jobd-section">
            <div class="row g-3">
                <div class="col-lg-6">
                    <h6 class="mb-2">Key Details</h6>
                    <div class="jobd-facts">
                        <div class="jobd-fact"><i class="bi bi-briefcase"></i><div><strong>Type:</strong> @Model.JobType</div></div>
                        <div class="jobd-fact"><i class="bi bi-tag"></i><div><strong>Category:</strong> @(Model.Category?.Name ?? "-")</div></div>
                        <div class="jobd-fact"><i class="bi bi-cash-coin"></i><div><strong>Salary:</strong> RM @Money(Model.MinSalary) – RM @Money(Model.MaxSalary)</div></div>
                        <div class="jobd-fact"><i class="bi bi-geo-alt"></i><div><strong>Location:</strong> @Model.Location</div></div>
                        <div class="jobd-fact">
                            <i class="bi bi-calendar-event"></i>
                            <div>
                                <strong>Posted:</strong> @Model.PostedDate.ToLocalTime().ToString("dd MMM yyyy")
                                @if (Model.ClosingDate.HasValue)
                                {
                                    <text>&nbsp;•&nbsp;<strong>Closes:</strong> @Model.ClosingDate.Value.ToLocalTime().ToString("dd MMM yyyy")</text>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <h6 class="mb-2">Company</h6>
                    <div class="jobd-pane">
                        <div class="fw-semibold">@Model.Employer?.CompanyName</div>
                        @if (!string.IsNullOrWhiteSpace(Model.Employer?.CompanyAddress))
                        {
                            <div class="text-muted small mb-1">@Model.Employer.CompanyAddress</div>
                        }
                        @if (!string.IsNullOrWhiteSpace(Model.Employer?.Website))
                        {
                            <a href="@Model.Employer.Website" target="_blank" rel="noopener" class="btn btn-sm btn-outline-primary mt-1">
                                <i class="bi bi-globe2"></i> Website
                            </a>
                        }
                    </div>

                    <h6 class="mt-3 mb-2">Approximate Location</h6>
                    <div class="jobd-pane">
                        <div class="d-flex justify-content-start">
                            @if (Model.Latitude.HasValue && Model.Longitude.HasValue)
                            {
                                <a target="_blank" class="btn btn-sm btn-outline-success brand-green"
                                   href="https://www.google.com/maps/search/?api=1&query=@Model.Latitude,@Model.Longitude">
                                    <i class="bi bi-globe2"></i> Open in Google Maps
                                </a>
                            }
                            else
                            {
                                <a target="_blank" class="btn btn-sm btn-outline-success brand-green"
                                   href="https://www.google.com/maps/search/@Uri.EscapeDataString(Model.Location ?? "")">
                                    <i class="bi bi-globe2"></i> Open in Google Maps
                                </a>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Apply Modal (content loaded dynamically) -->
<div class="modal fade" id="applyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content" id="applyModalContent">
            <div class="p-4 text-center text-muted">
                <div class="spinner-border" role="status"><span class="visually-hidden">Loading…</span></div>
                <div class="mt-2 small">Loading form…</div>
            </div>
        </div>
    </div>
</div>

<!-- Report Job Modal -->
<div class="modal fade" id="reportJobModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form id="reportJobForm" class="modal-content report-modal">
            <div class="modal-header border-0 pb-0">
                <div class="d-flex align-items-center gap-2">
                    <div class="icon-pill"><i class="bi bi-flag-fill"></i></div>
                    <h5 class="modal-title fw-semibold mb-0">Report Job</h5>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body pt-3">
                @Html.AntiForgeryToken()
                <input type="hidden" name="JobId" value="@Model.Id" />

                <div class="mb-3">
                    <label class="form-label">Reason <span class="text-danger">*</span></label>
                    <input type="text" name="Reason" class="form-control form-control-lg" maxlength="100" required
                           placeholder="e.g. Scam suspicion, duplicate post, misleading salary…" />
                    <div class="form-text d-flex justify-content-between">
                        <span>Please be concise and specific.</span>
                        <span><span id="reasonCount">0</span>/100</span>
                    </div>
                </div>

                <div class="mb-2">
                    <label class="form-label">Additional details (optional)</label>
                    <textarea name="Details" class="form-control" rows="4" maxlength="1500"
                              placeholder="Share any helpful context, screenshots you noticed, links, etc."></textarea>
                    <div class="form-text text-end"><span id="detailsCount">0</span>/1500</div>
                </div>
                <div class="callout"><i class="bi bi-shield-check me-2"></i> Your report is sent privately to our admin team.</div>
            </div>

            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary btn-submit">
                    <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
                    Submit report
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    /* ... (your modal styles unchanged) ... */
</style>

@await Html.PartialAsync("~/Views/JobSeekerActions/_ApplyHost.cshtml")

<script>
    /* Report modal Ajax (unchanged core, trimmed for brevity) */
    (function () {
      const form = document.getElementById('reportJobForm');
      const reason = form.querySelector('input[name="Reason"]');
      const details = form.querySelector('textarea[name="Details"]');
      const reasonCount = document.getElementById('reasonCount');
      const detailsCount = document.getElementById('detailsCount');
      const submitBtn = form.querySelector('.btn-submit');
      const spinner = submitBtn.querySelector('.spinner-border');
      const updateCounter = (el, out) => out.textContent = (el.value || '').length;
      ['input','change'].forEach(evt=>{
          reason.addEventListener(evt, () => updateCounter(reason, reasonCount));
          details.addEventListener(evt, () => updateCounter(details, detailsCount));
      });
      updateCounter(reason, reasonCount); updateCounter(details, detailsCount);

      form.addEventListener('submit', function (e) {
        e.preventDefault();
        if (!reason.value.trim()) { reason.focus(); return; }
        const fd = new URLSearchParams(new FormData(form));

        const token = form.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
        spinner.classList.remove('d-none'); submitBtn.disabled = true;

        fetch('@Url.Content("~/ReportJob")', {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type':'application/x-www-form-urlencoded',
            'X-CSRF-TOKEN': token
          },
          credentials: 'same-origin'
          , body: fd
        }).then(r=>r.ok ? r.json() : Promise.reject())
          .then(res=>{
            const modal = bootstrap.Modal.getInstance(document.getElementById('reportJobModal'));
            if(res?.success){ modal.hide(); alert(res.message || 'Thanks for your report. We’ll review it shortly.'); }
            else { alert(res?.message || 'Could not submit the report.'); }
          }).catch(()=> alert('Server error submitting the report.'))
          .finally(()=>{ spinner.classList.add('d-none'); submitBtn.disabled = false; });
      });
    })();
</script>

@section Scripts {
    <script>
        /* Simple toast helper used by save/unsave */
        function showToast(msg, ok = true) {
          let c = document.querySelector('.toast-container');
          if (!c) {
            c = document.createElement('div');
            c.className = 'toast-container position-fixed top-0 end-0 p-3';
            c.style.zIndex = '1080';
            document.body.appendChild(c);
          }
          const el = document.createElement('div');
          el.className = `toast align-items-center text-white ${ok ? 'bg-success' : 'bg-danger'} border-0 show`;
          el.role = 'alert';
          el.style.minWidth = '280px';
          el.innerHTML = `
            <div class="d-flex">
              <div class="toast-body">${msg}</div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>`;
          c.appendChild(el);
          setTimeout(()=> el.remove(), 3500);
        }

        /* Apply modal loader (unchanged) + Save/Unsave with CSRF header */
        (() => {
          const modalEl=document.getElementById('applyModal');
          const bodyEl=document.getElementById('applyModalContent');
          const triggerBtn=document.getElementById('btnOpenApply');
          const applyPopupBaseUrl='@Url.Action("ApplyPopup", "JobSeekerActions")';
          function renderError(msg){ bodyEl.innerHTML=`<div class="modal-body"><div class="alert alert-danger">${msg}</div></div>`; }
          function setLoading(){ bodyEl.innerHTML=`<div class="p-4 text-center text-muted"><div class="spinner-border" role="status"></div><div class="mt-2 small">Loading form…</div></div>`; }
          async function loadApplyForm(jobId){
            if(!jobId){ renderError("Missing job id."); return; }
            setLoading();
            try{
              const url = new URL(applyPopupBaseUrl, location.origin); url.searchParams.set('jobId', jobId);
              const resp = await fetch(url.toString(), { headers:{ "X-Requested-With":"XMLHttpRequest" } });
              if(!resp.ok){ renderError(`Failed to load form (HTTP ${resp.status}).`); return; }
              bodyEl.innerHTML = await resp.text();
            }catch{ renderError("Failed to load form."); }
          }
          modalEl.addEventListener('show.bs.modal', ev => {
            const from = ev.relatedTarget || triggerBtn;
            const jobId = from?.getAttribute('data-jobid');
            loadApplyForm(jobId);
          });
          modalEl.addEventListener('hidden.bs.modal', ()=>{ bodyEl.innerHTML=""; });

          // Save / Unsave AJAX with CSRF header + credentials
          const saveForm=document.getElementById('saveForm');
          const unsaveForm=document.getElementById('unsaveForm');

          async function handleSaveUnsave(e){
            e.preventDefault();
            const form=e.currentTarget;
            const fd=new FormData(form);
            const token = form.querySelector('input[name="__RequestVerificationToken"]')?.value || '';

            try{
              const res=await fetch(form.action,{
                method:'POST',
                headers:{
                  'X-Requested-With':'XMLHttpRequest',
                  'X-CSRF-TOKEN': token
                },
                credentials: 'same-origin',
                body:fd
              });

              if (res.status === 401 || res.status === 403) {
                showToast('Please sign in to save jobs or try again.', false);
                return;
              }
              if(!res.ok){ showToast('Could not update saved state.', false); return; }

              const json=await res.json();
              if(json?.success){
                const saved = json.saved === true;
                if(saved){
                  saveForm?.classList.add('d-none'); unsaveForm?.classList.remove('d-none');
                  showToast('Saved to your jobs.');
                }else{
                  unsaveForm?.classList.add('d-none'); saveForm?.classList.remove('d-none');
                  showToast('Removed from saved.');
                }
              }else{
                showToast(json?.message || 'Could not update saved state.', false);
              }
            }catch{ showToast('Network/server error. Please try again.', false); }
          }
          saveForm?.addEventListener('submit', handleSaveUnsave);
          unsaveForm?.addEventListener('submit', handleSaveUnsave);
        })();
    </script>
}
