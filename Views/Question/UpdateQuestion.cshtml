@model JobRecruitment.Models.QuestionSetViewModel

@{
    ViewData["Title"] = "Edit Question Set";
    Layout = "~/Views/Shared/_EmployeeLayout.cshtml";
}

@if (TempData["SuccessMessage"] != null)
{
    <link rel="stylesheet" href="~/css/MessageBoxes.css">
    <div class="success-toast">
        <div class="success-card">
            <div class="icon">🥳</div>
            <h2>@(TempData["SuccessTitle"] ?? "Success!")</h2>
            <p>@TempData["SuccessMessage"]</p>
        </div>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div id="errorBox"
         style="display: block; background: rgba(0,0,0,0.6);
                     position: fixed; inset: 0; z-index: 9999;
                     display: flex; justify-content: center; align-items: center;">

        <div style="background: #f87171; color: white; border-radius: 12px;
                         padding: 25px 30px; text-align: center; width: 320px;
                         box-shadow: 0 8px 30px rgba(0,0,0,0.25);
                         animation: popIn 0.3s ease-out;">

            <div style="font-size: 50px; margin-bottom: 15px;">😟</div>
            <h2 style="margin: 0 0 10px; font-size: 1.5rem;">
                @(TempData["ErrorTitle"] ?? "Oops!")
            </h2>
            <p style="font-size: 0.95rem; margin-bottom: 20px;">
                @TempData["ErrorMessage"]
            </p>

            <button onclick="document.getElementById('errorBox').style.display='none'"
                    style="background: white; color: #b91c1c; border: none;
                                padding: 10px 25px; border-radius: 50px;
                                font-size: 1rem; cursor: pointer;">
                OK
            </button>
        </div>
    </div>
}

@section Head {
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="~/css/questionForm.css" asp-append-version="true" />
    <style>
        /* Modal styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1050;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            outline: 0;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-dialog {
            position: relative;
            width: auto;
            margin: 0.5rem;
            pointer-events: none;
        }

        .modal-content {
            position: relative;
            display: flex;
            flex-direction: column;
            width: 100%;
            pointer-events: auto;
            background-color: #fff;
            background-clip: padding-box;
            border: 1px solid rgba(0, 0, 0, 0.2);
            border-radius: 0.3rem;
            outline: 0;
        }

        .modal-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 1rem 1rem;
            border-bottom: 1px solid #dee2e6;
            border-top-left-radius: calc(0.3rem - 1px);
            border-top-right-radius: calc(0.3rem - 1px);
        }

        .modal-body {
            position: relative;
            flex: 1 1 auto;
            padding: 1rem;
        }

        .modal-footer {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-end;
            padding: 0.75rem;
            border-top: 1px solid #dee2e6;
            border-bottom-right-radius: calc(0.3rem - 1px);
            border-bottom-left-radius: calc(0.3rem - 1px);
        }

        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1040;
            width: 100vw;
            height: 100vh;
            background-color: #000;
        }

            .modal-backdrop.fade {
                opacity: 0;
            }

            .modal-backdrop.show {
                opacity: 0.5;
            }

        .modal.fade .modal-dialog {
            transition: transform 0.3s ease-out;
            transform: translate(0, -50px);
        }

        .modal.show .modal-dialog {
            transform: none;
        }

        /* Alert card styling */
        .alert-card.error {
            background: #f87171;
            color: white;
            border-radius: 12px;
            padding: 25px 30px;
            text-align: center;
            width: 100%;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .alert-card .icon {
            font-size: 50px;
            margin-bottom: 15px;
        }

        .alert-card h2 {
            margin: 0 0 10px;
            font-size: 1.5rem;
        }

        .alert-card p {
            font-size: 0.95rem;
            margin: 5px 0;
        }

        .alert-card .note-text {
            color: #FFFFFF;
            margin-top: 10px;
        }

        /* Minimal centering for modal */
        .modal-dialog-centered-custom {
            display: flex;
            min-height: 100vh;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }

            .modal-dialog-centered-custom .modal-content {
                width: 100%;
                max-width: 500px;
            }
    </style>
}

<div class="container-fluid my-4 px-0">
    <div class="card question-card mx-0">
        <div class="card-body px-3">
            <div class="edit-header d-flex justify-content-between align-items-center mb-4">
                <h4>Edit Question Set</h4>
                <span class="badge @(Model.IsActive ? "bg-success" : "bg-secondary") status-badge">
                    @(Model.IsActive ? "Active" : "Inactive")
                </span>
            </div>

            <form asp-action="UpdateQuestion" method="post" id="questionSetForm">
                @Html.AntiForgeryToken()

                <input type="hidden" asp-for="EmployerId" />
                <input type="hidden" asp-for="Id" />
                <input type="hidden" asp-for="IsActive" id="IsActiveHidden" />

                <!-- Hidden field for deleted questions -->
                <div id="deleted-questions-container"></div>

                <!-- Validation Summary (centered) -->
                <div class="validation-summary">
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger validation-summary-errors"></div>
                </div>

                <!-- Question Set Title with character counter -->
                <div class="form-group">
                    <label asp-for="Name" class="required"></label>
                    <input asp-for="Name" class="form-control" placeholder="Enter question set title"
                           maxlength="100" required />
                    <small class="character-counter text-muted" id="title-counter">@(Model.Name?.Length ?? 0)/100 characters</small>
                    <span asp-validation-for="Name" class="invalid-feedback">Question set title is required.</span>
                </div>

                <!-- Description with character counter -->
                <div class="form-group">
                    <label asp-for="Description"></label>
                    <textarea asp-for="Description" class="form-control" rows="3"
                              placeholder="Enter description"
                              maxlength="1000"></textarea>
                    <small class="character-counter text-muted" id="description-counter">@(Model.Description?.Length ?? 0)/1000 characters</small>
                </div>

                <!-- Questions Header -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Questions</h5>
                </div>

                <!-- Questions Container -->
                <div id="questions-container">
                    @if (Model.Questions != null && Model.Questions.Any())
                    {
                        @for (int i = 0; i < Model.Questions.Count; i++)
                        {
                            <div class="question-card card mb-3" data-index="@i" data-question-id="@Model.Questions[i].Id">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <span class="material-icons drag-handle">drag_indicator</span>
                                        <button type="button" class="btn btn-sm btn-outline-danger remove-question"
                                                data-question-id="@Model.Questions[i].Id">
                                            <i class="fas fa-trash me-1"></i> Delete
                                        </button>
                                    </div>

                                    <div class="row mb-3">
                                        <div class="col-md-8">
                                            <div class="form-group">
                                                <label class="required">Question Text</label>
                                                <input asp-for="Questions[i].Text" class="form-control question-title" placeholder="Enter question text"
                                                       required />
                                                <span asp-validation-for="Questions[i].Text" class="invalid-feedback">Question text is required.</span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label class="required">Question Type</label>
                                                <select asp-for="Questions[i].Type" class="form-select question-type" required>
                                                    <option value="">-- Select Type --</option>
                                                    <option value="Text">Text</option>
                                                    <option value="TextArea">Text Area</option>
                                                    <option value="MultipleChoice">Multiple Choice</option>
                                                    <option value="Checkbox">Checkbox</option>
                                                    <option value="Dropdown">Dropdown</option>
                                                    <option value="FileUpload">File Upload</option>
                                                    <option value="Date">Date</option>
                                                </select>
                                                <span asp-validation-for="Questions[i].Type" class="invalid-feedback">Question type is required.</span>
                                            </div>
                                        </div>
                                    </div>

                                    <input type="hidden" asp-for="Questions[i].Id" class="question-id" />
                                    <input type="hidden" asp-for="Questions[i].Order" class="question-order" value="@(i + 1)" />

                                    <!-- Options Container -->
                                    <div class="options-input mb-3" style="display: none;">
                                        <label class="form-label required">Options (one per line)</label>
                                        <div class="option-inputs">
                                            @if (!string.IsNullOrEmpty(Model.Questions[i].Options))
                                            {
                                                var options = Model.Questions[i].Options.Split(',');
                                                foreach (var option in options)
                                                {
                                                    <div class="option-input mb-2">
                                                        <input type="text" class="form-control option-text-input" placeholder="Option text"
                                                               value="@option.Trim()" required />
                                                        <button type="button" class="option-remove-btn">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                }
                                            }
                                            else
                                            {
                                                <div class="option-input mb-2">
                                                    <input type="text" class="form-control option-text-input" placeholder="Option text" required />
                                                    <button type="button" class="option-remove-btn">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                                <div class="option-input mb-2">
                                                    <input type="text" class="form-control option-text-input" placeholder="Option text" required />
                                                    <button type="button" class="option-remove-btn">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            }
                                        </div>
                                        <button type="button" class="btn btn-sm btn-primary add-option-btn">
                                            <i class="fas fa-plus me-1"></i> Add Option
                                        </button>
                                        <input type="hidden" asp-for="Questions[i].Options" class="options-data" />
                                        <span class="invalid-feedback">At least two options are required.</span>
                                    </div>

                                    <!-- Max Length Input -->
                                    <div class="max-length-input mb-3" style="display: none;">
                                        <div class="form-group">
                                            <label>Maximum Length</label>
                                            <input asp-for="Questions[i].MaxLength" type="number" min="1" max="5000" class="form-control"
                                                   placeholder="Enter maximum character length" />
                                            <span asp-validation-for="Questions[i].MaxLength" class="invalid-feedback">Please enter a valid number between 1 and 5000.</span>
                                        </div>
                                    </div>

                                    <!-- Required Toggle Switch -->
                                    <div class="toggle-container">
                                        <label class="toggle-switch">
                                            <input type="checkbox" asp-for="Questions[i].IsRequired" class="toggle-checkbox" />
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span class="toggle-label">Required Question</span>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="no-questions-message">
                            <p>No questions added yet. Click the "Add Question" button below to get started.</p>
                        </div>
                    }
                </div>

                <!-- Add Question Button at the bottom -->
                <div class="add-question-container mt-3">
                    <button type="button" id="add-question" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i> Add Question
                    </button>
                </div>

                <!-- Form Actions -->
                <div class="d-flex justify-content-end gap-2 mt-4">
                    <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-outline-secondary">Cancel</a>
                    <button type="submit" class="btn btn-primary">Update Question Set</button>

                    @if (Model.IsActive)
                    {
                        <button type="button" class="btn btn-danger ms-auto" data-bs-toggle="modal" data-bs-target="#deactivateModal">
                            <i class="fas fa-ban me-1"></i> Deactivate Set
                        </button>
                    }
                    else
                    {
                        <button type="button" class="btn btn-success ms-auto" id="activate-btn">
                            <i class="fas fa-check me-1"></i> Activate Set
                        </button>
                    }
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Deactivate Confirmation Modal - Centered Structure -->
<div class="modal fade" id="deactivateModal" tabindex="-1" aria-labelledby="deactivateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-centered-custom">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deactivateModalLabel">Deactivate Question Set</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="alert-card error mx-auto">
                    <div class="icon">🤔</div>
                    <h2><strong>Deactivate Question Set</strong></h2>
                    <p>Are you sure you want to deactivate this question set?</p>
                    <p class="note-text"><strong>⚠️Note: This will make the question set unavailable for new job assignments.</strong> </p>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-deactivate">Deactivate</button>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script src="~/js/questionFormValidation.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script>
        // Track deleted questions
        const deletedQuestionIds = [];
        let newQuestionCount = 0;

        // Add hidden field for deleted question IDs - FIXED ARRAY FORMAT
        function addDeletedQuestionsToForm() {
            const container = document.getElementById('deleted-questions-container');
            container.innerHTML = ''; // Clear existing

            // Use array format for model binding: DeletedQuestionIds[0], DeletedQuestionIds[1], etc.
            deletedQuestionIds.forEach((id, index) => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = `DeletedQuestionIds[${index}]`; // Array format
                input.value = id;
                container.appendChild(input);
            });

            console.log('Added deleted questions to form:', deletedQuestionIds);
        }

        // Initialize character counters
        function updateCharacterCounter(input, counterId) {
            const counter = document.getElementById(counterId);
            if (counter) {
                const maxLength = parseInt(input.getAttribute('maxlength')) || 100;
                const currentLength = input.value.length;

                counter.textContent = `${currentLength}/${maxLength} characters`;

                // Remove all color classes first
                counter.classList.remove('text-muted', 'text-warning');

                // Add appropriate color class
                if (currentLength > maxLength * 0.9) {
                    counter.classList.add('text-warning');
                } else {
                    counter.classList.add('text-muted');
                }
            }
        }

        // Real-time validation functions
        function validateField(input) {
            const value = input.value.trim();
            const feedback = input.nextElementSibling;

            // Remove validation first
            input.classList.remove('is-invalid');
            if (feedback && feedback.classList.contains('invalid-feedback')) {
                feedback.style.display = 'none';
            }

            // Skip validation if field is empty and not required
            if (!value && !input.hasAttribute('required')) {
                return true;
            }

            let isValid = true;
            let errorMessage = '';

            // Required field validation
            if (input.hasAttribute('required') && !value) {
                isValid = false;
                errorMessage = feedback?.textContent || 'This field is required.';
            }

            // Number validation
            else if (input.type === 'number' && value) {
                const min = parseInt(input.getAttribute('min')) || 1;
                const max = parseInt(input.getAttribute('max')) || 5000;
                const numValue = parseInt(value);

                if (isNaN(numValue) || numValue < min || numValue > max) {
                    isValid = false;
                    errorMessage = `Please enter a number between ${min} and ${max}.`;
                }
            }

            if (!isValid) {
                input.classList.add('is-invalid');
                if (feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.textContent = errorMessage;
                    feedback.style.display = 'block';
                }
            }

            return isValid;
        }

        function validateOptions(questionCard) {
            const typeSelect = questionCard.querySelector('.question-type');
            const optionsInput = questionCard.querySelector('.options-input');
            const optionsFeedback = optionsInput?.querySelector('.invalid-feedback');

            if (!['MultipleChoice', 'Checkbox', 'Dropdown'].includes(typeSelect?.value)) {
                if (optionsInput) {
                    optionsInput.classList.remove('is-invalid');
                    if (optionsFeedback) optionsFeedback.style.display = 'none';
                }
                return true;
            }

            const optionInputs = questionCard.querySelectorAll('.option-text-input');
            const options = Array.from(optionInputs).map(input => input.value.trim()).filter(val => val);

            if (options.length < 2) {
                optionsInput.classList.add('is-invalid');
                if (optionsFeedback) {
                    optionsFeedback.style.display = 'block';
                }
                return false;
            } else {
                optionsInput.classList.remove('is-invalid');
                if (optionsFeedback) {
                    optionsFeedback.style.display = 'none';
                }
                return true;
            }
        }

        // Toggle options based on question type
        function toggleQuestionOptions(select) {
            const questionCard = select.closest('.question-card');
            const optionsInput = questionCard.querySelector('.options-input');
            const maxLengthInput = questionCard.querySelector('.max-length-input');
            const type = select.value;

            // Hide both initially
            if (optionsInput) optionsInput.style.display = 'none';
            if (maxLengthInput) maxLengthInput.style.display = 'none';

            // Show options for multiple choice, checkbox, and dropdown
            if (['MultipleChoice', 'Checkbox', 'Dropdown'].includes(type)) {
                optionsInput.style.display = 'block';
            }
            // Show max length for text and textarea
            else if (['Text', 'TextArea'].includes(type)) {
                maxLengthInput.style.display = 'block';
            }

            // Validate options when type changes
            validateOptions(questionCard);
        }

        // Add new question
        function addNewQuestion() {
            const container = document.getElementById('questions-container');
            const questionCount = container.querySelectorAll('.question-card').length;
            const newIndex = questionCount;
            newQuestionCount++;

            // Remove the no questions message if it exists
            const noQuestionsMessage = container.querySelector('.no-questions-message');
            if (noQuestionsMessage) {
                noQuestionsMessage.remove();
            }

            // Create new question card
            const newQuestion = document.createElement('div');
            newQuestion.className = 'question-card card mb-3';
            newQuestion.dataset.index = newIndex;
            newQuestion.dataset.questionId = 'new-' + newQuestionCount;
            newQuestion.innerHTML = `
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="material-icons drag-handle">drag_indicator</span>
                        <button type="button" class="btn btn-sm btn-outline-danger remove-question" data-question-id="new-${newQuestionCount}">
                            <i class="fas fa-trash me-1"></i> Delete
                        </button>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label class="required">Question Text</label>
                                <input name="Questions[${newIndex}].Text" class="form-control question-title" placeholder="Enter question text" required />
                                <span class="invalid-feedback">Question text is required.</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="required">Question Type</label>
                                <select name="Questions[${newIndex}].Type" class="form-select question-type" required>
                                    <option value="">-- Select Type --</option>
                                    <option value="Text">Text</option>
                                    <option value="TextArea">Text Area</option>
                                    <option value="MultipleChoice">Multiple Choice</option>
                                    <option value="Checkbox">Checkbox</option>
                                    <option value="Dropdown">Dropdown</option>
                                    <option value="FileUpload">File Upload</option>
                                    <option value="Date">Date</option>
                                </select>
                                <span class="invalid-feedback">Question type is required.</span>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" name="Questions[${newIndex}].Id" value="" class="question-id" />
                    <input type="hidden" name="Questions[${newIndex}].Order" class="question-order" value="${newIndex + 1}" />

                    <!-- Options Container -->
                    <div class="options-input mb-3" style="display: none;">
                        <label class="form-label required">Options (one per line)</label>
                        <div class="option-inputs">
                            <div class="option-input mb-2">
                                <input type="text" class="form-control option-text-input" placeholder="Option text" required />
                                <button type="button" class="option-remove-btn">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="option-input mb-2">
                                <input type="text" class="form-control option-text-input" placeholder="Option text" required />
                                <button type="button" class="option-remove-btn">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-primary add-option-btn">
                            <i class="fas fa-plus me-1"></i> Add Option
                        </button>
                        <input type="hidden" name="Questions[${newIndex}].Options" class="options-data" />
                        <span class="invalid-feedback">At least two options are required.</span>
                    </div>

                    <!-- Max Length Input -->
                    <div class="max-length-input mb-3" style="display: none;">
                        <div class="form-group">
                            <label>Maximum Length</label>
                            <input name="Questions[${newIndex}].MaxLength" type="number" min="1" max="5000" class="form-control" placeholder="Enter maximum character length" />
                            <span class="invalid-feedback">Please enter a valid number between 1 and 5000.</span>
                        </div>
                    </div>

                    <!-- Required Toggle Switch -->
                    <div class="toggle-container">
                        <label class="toggle-switch">
                            <input type="checkbox" name="Questions[${newIndex}].IsRequired" class="toggle-checkbox" value="true" />
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">Required Question</span>
                    </div>
                </div>
            `;

            container.appendChild(newQuestion);

            // Initialize the new question's functionality
            initQuestionCard(newQuestion);

            // Initialize toggle for the new question
            initToggleSwitchesForCard(newQuestion);

            // Reinitialize Sortable
            initSortable();

            console.log('Added new question, total questions:', container.querySelectorAll('.question-card').length);
        }

        // Remove question with proper confirmation - FIXED
        function removeQuestion(button) {
            const questionCard = button.closest('.question-card');
            if (questionCard && confirm('Are you sure you want to remove this question?')) {
                const questionId = questionCard.dataset.questionId;
                console.log('Removing question with ID:', questionId);

                // Add to deleted list whether it's new or existing
                if (questionId && !deletedQuestionIds.includes(questionId)) {
                    deletedQuestionIds.push(questionId);
                    console.log('Added to deleted list:', deletedQuestionIds);
                }

                // Remove from DOM and update form
                questionCard.remove();
                addDeletedQuestionsToForm();
                reindexQuestions();
            }
        }

        // Add option
        function addOption(button) {
            const optionsContainer = button.previousElementSibling;
            const optionInput = document.createElement('div');
            optionInput.className = 'option-input mb-2';
            optionInput.innerHTML = `
                <input type="text" class="form-control option-text-input" placeholder="Option text" required />
                <button type="button" class="option-remove-btn">
                    <i class="fas fa-times"></i>
                </button>
            `;
            optionsContainer.appendChild(optionInput);

            updateOptionsData(button.closest('.question-card'));
        }

        // Remove option
        function removeOption(button) {
            const optionInput = button.closest('.option-input');
            const questionCard = button.closest('.question-card');
            if (optionInput && questionCard) {
                optionInput.remove();
                updateOptionsData(questionCard);
                validateOptions(questionCard);
            }
        }

        // Update options data
        function updateOptionsData(questionCard) {
            const optionInputs = questionCard.querySelectorAll('.option-text-input');
            const optionsData = questionCard.querySelector('.options-data');

            // Safety check - if optionsData doesn't exist, exit early
            if (!optionsData) {
                console.log('options-data element not found, skipping update');
                return;
            }

            const options = Array.from(optionInputs).map(input => input.value.trim()).filter(val => val);

            // Only set value if there are options, otherwise set empty string
            optionsData.value = options.length > 0 ? options.join(',') : '';
        }

        // Initialize Sortable
        function initSortable() {
            const container = document.getElementById('questions-container');
            if (container) {
                // Destroy existing Sortable instance if any
                if (container.sortable) {
                    container.sortable.destroy();
                }

                // Only initialize if there are questions
                if (container.querySelectorAll('.question-card').length > 0) {
                    container.sortable = new Sortable(container, {
                        animation: 150,
                        handle: '.drag-handle',
                        ghostClass: 'sortable-ghost',
                        onEnd: function () {
                            reindexQuestions();
                        }
                    });
                }
            }
        }

        // Reindex questions after drag and drop or deletion - IMPROVED
        function reindexQuestions() {
            const container = document.getElementById('questions-container');
            const questionCards = container.querySelectorAll('.question-card');

            console.log('Reindexing questions. Current count:', questionCards.length);

            // If no questions, add the no questions message
            if (questionCards.length === 0) {
                container.innerHTML = '<div class="no-questions-message"><p>No questions added yet. Click the "Add Question" button below to get started.</p></div>';
                return;
            }

            // Remove the no questions message if it exists
            const noQuestionsMessage = container.querySelector('.no-questions-message');
            if (noQuestionsMessage) {
                noQuestionsMessage.remove();
            }

            questionCards.forEach((card, index) => {
                const newIndex = index;
                card.dataset.index = newIndex;

                // Update all input names
                const inputs = card.querySelectorAll('input, select');
                inputs.forEach(input => {
                    const name = input.getAttribute('name');
                    if (name && name.includes('Questions[')) {
                        // Extract the property name (e.g., "Text", "Type")
                        const propName = name.split('.').pop();
                        const newName = `Questions[${newIndex}].${propName}`;
                        input.setAttribute('name', newName);
                    }
                });

                // Update order value
                const orderInput = card.querySelector('.question-order');
                if (orderInput) {
                    orderInput.value = newIndex + 1;
                }
            });

            console.log('Reindexing completed');
        }

        // Clean up validation for deleted questions
        function cleanupValidation() {
            // Remove any validation messages that might be lingering
            document.querySelectorAll('.is-invalid').forEach(element => {
                element.classList.remove('is-invalid');
            });

            // Hide any visible validation messages
            document.querySelectorAll('.invalid-feedback').forEach(feedback => {
                feedback.style.display = 'none';
            });
        }

        // Initialize toggle switches for a specific card
        function initToggleSwitchesForCard(card) {
            const toggle = card.querySelector('.toggle-switch');
            if (!toggle) return;

            const checkbox = toggle.querySelector('.toggle-checkbox');
            const slider = toggle.querySelector('.toggle-slider');

            // Remove any existing event listeners
            const newSlider = slider.cloneNode(true);
            slider.parentNode.replaceChild(newSlider, slider);

            // Add new event listener
            newSlider.addEventListener('click', function(e) {
                e.preventDefault();
                checkbox.checked = !checkbox.checked;
                // Trigger change event
                const event = new Event('change', { bubbles: true });
                checkbox.dispatchEvent(event);
            });
        }

        // Initialize all toggle switches
        function initToggleSwitches() {
            document.querySelectorAll('.toggle-switch').forEach(toggle => {
                const checkbox = toggle.querySelector('.toggle-checkbox');
                const slider = toggle.querySelector('.toggle-slider');

                // Remove any existing event listeners
                const newSlider = slider.cloneNode(true);
                slider.parentNode.replaceChild(newSlider, slider);

                // Add new event listener
                newSlider.addEventListener('click', function(e) {
                    e.preventDefault();
                    checkbox.checked = !checkbox.checked;
                    // Trigger change event
                    const event = new Event('change', { bubbles: true });
                    checkbox.dispatchEvent(event);
                });

                // Prevent double-toggling when clicking directly on checkbox
                checkbox.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            });
        }

        // Initialize a question card with all event handlers
        function initQuestionCard(card) {
            // Question type change
            const questionType = card.querySelector('.question-type');
            questionType.addEventListener('change', function() {
                toggleQuestionOptions(this);
            });

            // Initialize the question type display
            toggleQuestionOptions(questionType);

            // Real-time validation for inputs
            card.querySelectorAll('input, select').forEach(input => {
                input.addEventListener('input', function() {
                    validateField(this);
                    if (this.classList.contains('option-text-input')) {
                        const questionCard = this.closest('.question-card');
                        validateOptions(questionCard);
                    }
                });

                input.addEventListener('change', function() {
                    validateField(this);
                    if (this.classList.contains('question-type')) {
                        const questionCard = this.closest('.question-card');
                        validateOptions(questionCard);
                    }
                });
            });
        }

        // Form validation - ONLY validate visible questions
        function validateForm() {
            let isValid = true;

            // Validate question set title
            const titleInput = document.querySelector('input[name="Name"]');
            if (!validateField(titleInput)) {
                isValid = false;
            }

            // Check if we have any valid questions (not empty and not deleted)
            const hasValidQuestions = Array.from(document.querySelectorAll('.question-card')).some(card => {
                const textInput = card.querySelector('input[name$=".Text"]');
                return textInput && textInput.value.trim() !== '';
            });

            if (!hasValidQuestions) {
                // Show error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger';
                errorDiv.innerHTML = '<strong>Error:</strong> At least one valid question is required.';

                // Remove any existing error messages
                const existingErrors = document.querySelectorAll('.validation-summary-errors .alert-danger');
                existingErrors.forEach(error => error.remove());

                // Add to validation summary
                const validationSummary = document.querySelector('.validation-summary');
                if (validationSummary) {
                    validationSummary.appendChild(errorDiv);
                } else {
                    // Create validation summary if it doesn't exist
                    const newSummary = document.createElement('div');
                    newSummary.className = 'validation-summary';
                    newSummary.innerHTML = '<div asp-validation-summary="ModelOnly" class="alert alert-danger validation-summary-errors"></div>';
                    newSummary.querySelector('.validation-summary-errors').appendChild(errorDiv);

                    // Insert at the beginning of the form
                    const form = document.getElementById('questionSetForm');
                    form.insertBefore(newSummary, form.firstChild);
                }

                isValid = false;

                // Scroll to error
                errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            // Validate individual questions
            const questionCards = document.querySelectorAll('.question-card');

            questionCards.forEach((card, index) => {
                // Validate question text
                const textInput = card.querySelector('input[name$=".Text"]');
                if (textInput && textInput.value.trim() !== '' && !validateField(textInput)) {
                    isValid = false;
                }

                // Validate question type
                const typeSelect = card.querySelector('select[name$=".Type"]');
                if (typeSelect && typeSelect.value.trim() !== '' && !validateField(typeSelect)) {
                    isValid = false;
                }

                // Validate options
                if (!validateOptions(card)) {
                    isValid = false;
                }
            });

            return isValid;
        }

        document.addEventListener('click', function(e) {
            // Handle delete question buttons
            if (e.target.closest('.remove-question')) {
                const button = e.target.closest('.remove-question');
                removeQuestion(button);
                return; // Prevent other handlers
            }

            // Handle add option buttons
            if (e.target.closest('.add-option-btn')) {
                const button = e.target.closest('.add-option-btn');
                // Check if this is the exact element clicked, not a child
                if (e.target === button || e.target.parentElement === button) {
                    addOption(button);
                }
                return; // Prevent other handlers
            }

            // Handle remove option buttons
            if (e.target.closest('.option-remove-btn')) {
                const button = e.target.closest('.option-remove-btn');
                // Check if this is the exact element clicked, not a child
                if (e.target === button || e.target.parentElement === button) {
                    removeOption(button);
                }
                return; // Prevent other handlers
            }
        });

        // Also update the addOption function to prevent duplicates:
        function addOption(button) {
            // Check if this button was already processed in this event cycle
            if (button.dataset.processing) return;
            button.dataset.processing = 'true';

            setTimeout(() => {
                delete button.dataset.processing;
            }, 100);

            const optionsContainer = button.previousElementSibling;
            const optionInput = document.createElement('div');
            optionInput.className = 'option-input mb-2';
            optionInput.innerHTML = `
                <input type="text" class="form-control option-text-input" placeholder="Option text" required />
                <button type="button" class="option-remove-btn">
                    <i class="fas fa-times"></i>
                </button>
            `;
            optionsContainer.appendChild(optionInput);

            updateOptionsData(button.closest('.question-card'));
        }

        // Initialize everything on page load
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM loaded - initializing question form...');

            // Initialize character counters
            const titleInput = document.querySelector('input[name="Name"]');
            const descriptionInput = document.querySelector('textarea[name="Description"]');

            if (titleInput) {
                updateCharacterCounter(titleInput, 'title-counter');
                titleInput.addEventListener('input', function() {
                    updateCharacterCounter(this, 'title-counter');
                    validateField(this);
                });
            }

            if (descriptionInput) {
                updateCharacterCounter(descriptionInput, 'description-counter');
                descriptionInput.addEventListener('input', function() {
                    updateCharacterCounter(this, 'description-counter');
                });
            }

            // Initialize question type displays for existing questions
            document.querySelectorAll('.question-type').forEach(select => {
                toggleQuestionOptions(select);
            });

            // Initialize Sortable
            initSortable();

            // Initialize toggle switches
            initToggleSwitches();

            // Add validation on form submit
            document.getElementById('questionSetForm').addEventListener('submit', function (e) {
                console.log('=== FORM SUBMISSION STARTED ===');

                // First, update options for all questions
                document.querySelectorAll('.question-card').forEach(card => {
                    updateOptionsData(card);
                });

                // Then validate the form
                if (!validateForm()) {
                    console.log('Form validation failed - preventing submission');
                    e.preventDefault();
                    e.stopPropagation();

                    // Scroll to first error
                    const firstError = document.querySelector('.is-invalid');
                    if (firstError) {
                        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                } else {
                    console.log('Form validation passed - proceeding with submission');

                    // Add deleted questions to form before submission
                    addDeletedQuestionsToForm();
                }

                this.classList.add('was-validated');
            });

            // Add question button
            document.getElementById('add-question').addEventListener('click', function() {
                addNewQuestion();
            });

            // Initialize all existing question cards
            document.querySelectorAll('.question-card').forEach(card => {
                initQuestionCard(card);
            });

            // Deactivate button
            document.getElementById('confirm-deactivate').addEventListener('click', function() {
                document.getElementById('IsActiveHidden').value = 'false';
                document.getElementById('questionSetForm').submit();
            });

            // Activate button
            document.getElementById('activate-btn').addEventListener('click', function() {
                document.getElementById('IsActiveHidden').value = 'true';
                document.getElementById('questionSetForm').submit();
            });

            console.log('Question form initialization complete');
        });
    </script>
}