@model JobRecruitment.Models.JobSeekerViewModels.ApplicationsApplyVm

<div class="modal-header">
    <h5 class="modal-title">Apply to @Model.Job?.Title</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>

<div class="modal-body" style="max-height:70vh; overflow:auto;">
    <div asp-validation-summary="ModelOnly" class="text-danger mb-2"></div>

    <div class="alert alert-warning d-flex align-items-start">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <div><strong>Heads up:</strong> Once you submit, your answers will be <strong>locked</strong> and cannot be edited.</div>
    </div>

    <div class="d-flex align-items-center gap-2 small apply-meta mb-3">
        <i class="bi bi-briefcase"></i> @Model.Job?.Title
        <span class="mx-1">•</span>
        <i class="bi bi-buildings"></i> @Model.Job?.Employer?.CompanyName
        <span class="mx-1">•</span>
        <i class="bi bi-geo-alt"></i> @Model.Job?.Location
    </div>

    <form id="applyForm" class="apply-form"
          asp-controller="JobSeekerActions" asp-action="Apply"
          method="post" enctype="multipart/form-data" novalidate>
        @Html.AntiForgeryToken()
        <input type="hidden" name="JobId" value="@Model.JobId" />

        <!-- Resume (required) -->
        <div class="mb-3">
            <label class="form-label fw-semibold">Resume (PDF) <span class="text-danger">*</span></label>
            <input class="form-control" type="file" name="Resume" accept="application/pdf" />
            @{
                var err = ViewData.ModelState["Resume"]?.Errors.FirstOrDefault()?.ErrorMessage;
            }
            @if (!string.IsNullOrWhiteSpace(err))
            {
                <div class="text-danger small">@err</div>
            }
            <div class="form-text">PDF only, max 5 MB.</div>
        </div>

        <!-- Cover letter -->
        <div class="mb-4">
            <label class="form-label fw-semibold">Cover letter</label>
            <textarea class="form-control" name="CoverLetter" rows="4"
                      placeholder="Write a short note to the employer...">@Model.CoverLetter</textarea>
        </div>

        @if (Model.HasQuestions && Model.Questions?.Any() == true)
        {
            <h6 class="mt-3 mb-2">Application Questions</h6>

            @for (int i = 0; i < Model.Questions.Count; i++)
            {
                var q = Model.Questions[i];
                var opts = (q.OptionsCsv ?? string.Empty)
                .Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                .ToArray();

                var keyAnswer = $"Questions[{i}].Answer";
                var keyUpload = $"Questions[{i}].Upload";
                var errA = ViewData.ModelState[keyAnswer]?.Errors.FirstOrDefault()?.ErrorMessage;
                var errU = ViewData.ModelState[keyUpload]?.Errors.FirstOrDefault()?.ErrorMessage;

                <div class="apply-q mb-3" data-q-index="@i">
                    <label class="q-label fw-semibold">
                        @q.QuestionText
                        @if (q.IsRequired)
                        {
                            <span class="text-danger">*</span>
                        }
                    </label>

                    @switch (q.Type)
                    {
                        case JobRecruitment.Models.QuestionType.Text:
                            {
                                <input class="form-control" name="Questions[@i].Answer" value="@q.Answer" />
                                if (!string.IsNullOrWhiteSpace(errA))
                                {

                                    <div class="text-danger small">@errA</div>
                                }
                                break;
                            }
                        case JobRecruitment.Models.QuestionType.TextArea:
                            {
                                <textarea class="form-control" name="Questions[@i].Answer" rows="3">@q.Answer</textarea>
                                if (!string.IsNullOrWhiteSpace(errA))
                                {

                                    <div class="text-danger small">@errA</div>
                                }
                                break;
                            }
                        case JobRecruitment.Models.QuestionType.Date:
                            {
                                <input type="date" class="form-control" name="Questions[@i].Answer" value="@q.Answer" />
                                if (!string.IsNullOrWhiteSpace(errA))
                                {

                                    <div class="text-danger small">@errA</div>
                                }
                                break;
                            }
                        case JobRecruitment.Models.QuestionType.Dropdown:
                        case JobRecruitment.Models.QuestionType.MultipleChoice:
                            {
                                <select class="form-select" name="Questions[@i].Answer">
                                    <option value="">-- Select --</option>
                                    @foreach (var o in opts)
                                    {
                                        <option value="@o" selected="@(string.Equals(q.Answer, o, StringComparison.OrdinalIgnoreCase))">@o</option>
                                    }
                                </select>
                                if (!string.IsNullOrWhiteSpace(errA))
                                {

                                    <div class="text-danger small">@errA</div>
                                }
                                break;
                            }
                        case JobRecruitment.Models.QuestionType.Checkbox:
                            {
                                var picked = (q.Answer ?? string.Empty)
                                .Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                                .ToHashSet(StringComparer.OrdinalIgnoreCase);

                                <input type="hidden" name="Questions[@i].Answer" value="@q.Answer" />
                                @foreach (var o in opts)
                                {
                                    var id = $"q{i}_{o.Replace(" ", "_")}";
                                    <div class="form-check">
                                        <input class="form-check-input js-q-check"
                                               type="checkbox"
                                               id="@id"
                                               value="@o"
                                               checked="@(picked.Contains(o))"
                                               data-hidden-name="Questions[@i].Answer" />
                                        <label class="form-check-label" for="@id">@o</label>
                                    </div>
                                }
                                if (!string.IsNullOrWhiteSpace(errA))
                                {
                                    <div class="text-danger small">@errA</div>
                                }
                                break;
                            }
                        case JobRecruitment.Models.QuestionType.FileUpload:
                            {
                                <input class="form-control" type="file"
                                       name="Questions[@i].Upload"
                                       accept=".pdf,.doc,.docx,.png,.jpg,.jpeg" />
                                <div class="form-text">Allowed: PDF, DOC, DOCX, PNG, JPG. Max 10 MB.</div>
                                if (!string.IsNullOrWhiteSpace(errU))
                                {

                                    <div class="text-danger small">@errU</div>
                                }
                                break;
                            }
                        default:
                            {
                                <input class="form-control" name="Questions[@i].Answer" value="@q.Answer" />
                                if (!string.IsNullOrWhiteSpace(errA))
                                {

                                    <div class="text-danger small">@errA</div>
                                }
                                break;
                            }
                    }

                    <!-- metadata (do NOT post IsRequired) -->
                    <input type="hidden" name="Questions[@i].QuestionId" value="@q.QuestionId" />
                    <input type="hidden" name="Questions[@i].QuestionText" value="@q.QuestionText" />
                    <input type="hidden" name="Questions[@i].Type" value="@q.Type" />
                    <input type="hidden" name="Questions[@i].OptionsCsv" value="@q.OptionsCsv" />
                    @if (q.MaxLength.HasValue)
                    {
                        <input type="hidden" name="Questions[@i].MaxLength" value="@q.MaxLength" />
                    }
                </div>
            }
        }
    </form>
</div>

<div class="modal-footer" style="position:sticky; bottom:0; background:linear-gradient(180deg,transparent,rgba(255,255,255,.96) 30%);">
    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
    <button type="submit" class="btn btn-primary" form="applyForm">
        <i class="bi bi-check2-circle me-1"></i> Submit Answers
    </button>
</div>
<script>
    (() => {
      // keep checkbox groups' hidden Answer in sync
      document.querySelectorAll('#applyForm .js-q-check').forEach(chk => {
        chk.addEventListener('change', () => {
          const hiddenName = chk.getAttribute('data-hidden-name');
          if (!hiddenName) return;
          const group = [...document.querySelectorAll('#applyForm .js-q-check[data-hidden-name="'+hiddenName+'"]')];
          const vals = group.filter(x => x.checked).map(x => x.value);
          const hidden = document.querySelector('input[type="hidden"][name="'+hiddenName+'"]');
          if (hidden) hidden.value = vals.join(',');
        });
      });

      const form = document.getElementById('applyForm');
      if (!form) return;

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const fd = new FormData(form);
        const r = await fetch(form.action, {
          method: 'POST',
          body: fd,
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });

        const ct = r.headers.get('content-type') || '';

        if (ct.includes('application/json')) {
          const data = await r.json();

          if (data.success) {
            // close modal
            try {
              const modalEl = document.getElementById('applyModal');
              const inst = modalEl ? bootstrap.Modal.getInstance(modalEl) : null;
              inst?.hide();
            } catch {}

            // success popup (uses global showToast if available, else alert)
            (window.showToast ?? alert)(data.message || 'Application submitted successfully.', true);

            // small delay so user can see popup, then follow redirect
            setTimeout(() => {
              window.location = data.redirectUrl || window.location.href;
            }, 900);
            return;
          }

          // if your server sends back { html: "<partial...>" } for errors
          if (data.html) {
            const host = document.getElementById('applyModalContent');
            if (host) host.innerHTML = data.html;
            return;
          }
        }

        // fallback: server returned HTML (re-rendered partial)
        const html = await r.text();
        const host = document.getElementById('applyModalContent');
        if (host) host.innerHTML = html;
      });
    })();
</script>
