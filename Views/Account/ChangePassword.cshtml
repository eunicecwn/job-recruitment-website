@{
    Layout = null;
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/images/logo.png">
    <title>Change Password</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Your Custom CSS -->
    <link rel="stylesheet" href="~/css/changepasswd.css" />

</head>
<body>
    <div class="main-container">
        <div class="card">
            <div class="card-header">
                <h3>
                    <img src="/images/logo.png" alt="HireRightPro Logo" class="ap-logo" />
                    <i></i>Change Password
                </h3>
            </div>
            <div class="card-body">
                @if (ViewBag.Error != null)
                {
                    <div class="alert alert-danger alert-dismissible fade show">
                        <i class="fas fa-exclamation-triangle me-2"></i>@ViewBag.Error
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                }

                @if (ViewBag.Success != null)
                {
                    <div class="alert alert-success alert-dismissible fade show">
                        <i class="fas fa-check-circle me-2"></i>@ViewBag.Success
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                }

                <form asp-action="ChangePassword" method="post">
                    @Html.AntiForgeryToken()

                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">
                            <i class="fas fa-lock me-1"></i>Current Password
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-lock"></i>
                            </span>
                            <input type="password" class="form-control"
                                   id="currentPassword" name="currentPassword"
                                   placeholder="Enter current password" required>
                            <button class="btn btn-outline-purple" type="button" id="toggleCurrentPassword">
                                <i class="fas fa-eye" id="toggleCurrentPasswordIcon"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="newPassword" class="form-label">
                            <i class="fas fa-key me-1"></i>New Password
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-key"></i>
                            </span>
                            <input type="password" class="form-control"
                                   id="newPassword" name="newPassword"
                                   placeholder="Enter new password" required minlength="6">
                            <button class="btn btn-outline-purple" type="button" id="toggleNewPassword">
                                <i class="fas fa-eye" id="toggleNewPasswordIcon"></i>
                            </button>
                        </div>
                        <div class="text-muted">Minimum 6 characters</div>
                    </div>

                    <div class="mb-4">
                        <label for="confirmPassword" class="form-label">
                            <i class="fas fa-check me-1"></i>Confirm New Password
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-check"></i>
                            </span>
                            <input type="password" class="form-control"
                                   id="confirmPassword" name="confirmPassword"
                                   placeholder="Confirm new password" required minlength="6">
                            <button class="btn btn-outline-purple" type="button" id="toggleConfirmPassword">
                                <i class="fas fa-eye" id="toggleConfirmPasswordIcon"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-4">
                        <button type="submit" class="btn btn-purple">
                            <i class="fas fa-key me-2"></i>Change Password
                        </button>
                    </div>
                </form>

                <div class="text-center">
                    <button onclick="goToDashboard()" class="btn-back">
                        <i class="fas fa-arrow-left"></i>Back to Dashboard
                    </button>
                </div>

                <div class="password-requirements">
                    <h6>
                        <i class="fas fa-info-circle me-1"></i>Password Requirements:
                    </h6>
                    <ul>
                        <li>At least 6 characters long</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
        // Role-based dashboard navigation
        function goToDashboard() {
            @if (User.IsInRole("Admin"))
            {
                <text>window.location.href = '@Url.Action("AdminDashboard", "Admin")';</text>
            }
            else if (User.IsInRole("Employer"))
            {
                <text>window.location.href = '@Url.Action("JobPost", "Job")';</text>
            }
            else if (User.IsInRole("JobSeeker"))
            {
                <text>window.location.href = '@Url.Action("Index", "Home")';</text>
            }
            else
            {
                <text>window.location.href = '@Url.Action("Index", "Home")';</text>
            }
        }

        // Enhanced form validation
        document.addEventListener('DOMContentLoaded', function() {
            const currentPassword = document.getElementById('currentPassword');
            const newPassword = document.getElementById('newPassword');
            const confirmPassword = document.getElementById('confirmPassword');
            const form = document.querySelector('form');

            // Password strength requirements
            const requirements = {
                length: /.{6,}/,  // Minimum 6 characters (as per your requirement)
                uppercase: /[A-Z]/,
                lowercase: /[a-z]/,
                number: /\d/,
                special: /[!@@#$%^&*(),.?":{}|<>]/
            };

            // Create validation feedback elements
            function createFeedbackElement(inputId) {
                const existingFeedback = document.querySelector(`#${inputId}-feedback`);
                if (existingFeedback) return existingFeedback;

                const feedback = document.createElement('div');
                feedback.id = `${inputId}-feedback`;
                feedback.className = 'invalid-feedback';
                feedback.style.display = 'none';
                feedback.style.fontSize = '0.875rem';
                feedback.style.marginTop = '0.25rem';
                
                const inputGroup = document.getElementById(inputId).closest('.input-group');
                inputGroup.parentNode.insertBefore(feedback, inputGroup.nextSibling);
                return feedback;
            }

            // Show validation feedback
            function showFeedback(inputId, message, isValid = false) {
                const input = document.getElementById(inputId);
                const feedback = createFeedbackElement(inputId);
                
                input.classList.remove('is-valid', 'is-invalid');
                feedback.style.display = 'block';
                
                if (isValid) {
                    input.classList.add('is-valid');
                    feedback.className = 'valid-feedback';
                    feedback.style.color = '#28a745';
                    feedback.innerHTML = `<i class="fas fa-check-circle me-1"></i>${message}`;
                } else {
                    input.classList.add('is-invalid');
                    feedback.className = 'invalid-feedback';
                    feedback.style.color = '#dc3545';
                    feedback.innerHTML = `<i class="fas fa-exclamation-circle me-1"></i>${message}`;
                }
            }

            // Hide validation feedback
            function hideFeedback(inputId) {
                const input = document.getElementById(inputId);
                const feedback = document.querySelector(`#${inputId}-feedback`);
                
                input.classList.remove('is-valid', 'is-invalid');
                if (feedback) {
                    feedback.style.display = 'none';
                }
            }

            // Validate current password
            function validateCurrentPassword() {
                const value = currentPassword.value.trim();
                
                if (value.length === 0) {
                    hideFeedback('currentPassword');
                    return false;
                }
                
                if (value.length < 6) {
                    showFeedback('currentPassword', 'Current password must be at least 6 characters');
                    return false;
                }
                
                showFeedback('currentPassword', 'Current password format is valid', true);
                return true;
            }

            // Check password strength
            function checkPasswordStrength(password) {
                let score = 0;
                const feedback = [];
                
                if (requirements.length.test(password)) {
                    score++;
                } else {
                    feedback.push('at least 6 characters');
                }
                
                if (requirements.uppercase.test(password)) {
                    score++;
                } else {
                    feedback.push('uppercase letter');
                }
                
                if (requirements.lowercase.test(password)) {
                    score++;
                } else {
                    feedback.push('lowercase letter');
                }
                
                if (requirements.number.test(password)) {
                    score++;
                } else {
                    feedback.push('number');
                }
                
                if (requirements.special.test(password)) {
                    score++;
                } else {
                    feedback.push('special character');
                }
                
                return { score, feedback };
            }

            // Validate new password
            function validateNewPassword() {
                const value = newPassword.value;
                
                if (value.length === 0) {
                    hideFeedback('newPassword');
                    return false;
                }

                // Check if new password is same as current password
                if (value === currentPassword.value && value.length > 0) {
                    showFeedback('newPassword', 'New password must be different from current password');
                    return false;
                }

                const strength = checkPasswordStrength(value);
                
                if (strength.score < 2) {
                    showFeedback('newPassword', `Weak password. Add: ${strength.feedback.join(', ')}`);
                    return false;
                } else if (strength.score < 4) {
                    showFeedback('newPassword', `Good password. Consider adding: ${strength.feedback.join(', ')}`, true);
                    return true;
                } else {
                    showFeedback('newPassword', 'Strong password!', true);
                    return true;
                }
            }

            // Validate password confirmation
            function validateConfirmPassword() {
                const value = confirmPassword.value;
                const newPasswordValue = newPassword.value;
                
                if (value.length === 0) {
                    hideFeedback('confirmPassword');
                    return false;
                }
                
                if (value !== newPasswordValue) {
                    showFeedback('confirmPassword', 'Passwords do not match');
                    confirmPassword.setCustomValidity("Passwords don't match");
                    return false;
                }
                
                if (newPasswordValue.length === 0) {
                    showFeedback('confirmPassword', 'Please enter new password first');
                    return false;
                }
                
                showFeedback('confirmPassword', 'Passwords match!', true);
                confirmPassword.setCustomValidity('');
                return true;
            }

            // Real-time validation events
            currentPassword.addEventListener('input', function() {
                validateCurrentPassword();
                // Re-validate new password if it exists (to check if different)
                if (newPassword.value.length > 0) {
                    validateNewPassword();
                }
            });
            currentPassword.addEventListener('blur', validateCurrentPassword);

            newPassword.addEventListener('input', function() {
                validateNewPassword();
                // Re-validate confirm password when new password changes
                if (confirmPassword.value.length > 0) {
                    validateConfirmPassword();
                }
            });
            newPassword.addEventListener('blur', validateNewPassword);

            confirmPassword.addEventListener('input', validateConfirmPassword);
            confirmPassword.addEventListener('blur', validateConfirmPassword);

            // Enhanced form submission validation
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const isCurrentPasswordValid = validateCurrentPassword();
                const isNewPasswordValid = validateNewPassword();
                const isConfirmPasswordValid = validateConfirmPassword();
                
                let hasErrors = false;
                const submitBtn = form.querySelector('button[type="submit"]');
                
                // Check if fields are empty
                if (currentPassword.value.trim().length === 0) {
                    showFeedback('currentPassword', 'Please enter your current password');
                    hasErrors = true;
                }
                
                if (newPassword.value.length === 0) {
                    showFeedback('newPassword', 'Please enter a new password');
                    hasErrors = true;
                }
                
                if (confirmPassword.value.length === 0) {
                    showFeedback('confirmPassword', 'Please confirm your new password');
                    hasErrors = true;
                }
                
                // Check validation results
                if (!isCurrentPasswordValid || !isNewPasswordValid || !isConfirmPasswordValid) {
                    hasErrors = true;
                }
                
                if (hasErrors) {
                    // Scroll to first error and focus
                    const firstError = form.querySelector('.is-invalid');
                    if (firstError) {
                        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        setTimeout(() => firstError.focus(), 300);
                    }
                    return false;
                }
                
                // If all validations pass, show loading state and submit
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Changing Password...';
                submitBtn.disabled = true;
                
                // Submit the form after a brief delay to show loading state
                setTimeout(() => {
                    form.submit();
                }, 500);
            });

            // Password visibility toggles
            function setupPasswordToggle(toggleId, passwordId, iconId) {
                const toggleBtn = document.getElementById(toggleId);
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', function() {
                        const passwordField = document.getElementById(passwordId);
                        const toggleIcon = document.getElementById(iconId);

                        if (passwordField && toggleIcon) {
                            if (passwordField.type === 'password') {
                                passwordField.type = 'text';
                                toggleIcon.classList.remove('fa-eye');
                                toggleIcon.classList.add('fa-eye-slash');
                                toggleBtn.title = 'Hide password';
                            } else {
                                passwordField.type = 'password';
                                toggleIcon.classList.remove('fa-eye-slash');
                                toggleIcon.classList.add('fa-eye');
                                toggleBtn.title = 'Show password';
                            }
                        }
                    });
                }
            }

            // Setup all password toggles
            setupPasswordToggle('toggleCurrentPassword', 'currentPassword', 'toggleCurrentPasswordIcon');
            setupPasswordToggle('toggleNewPassword', 'newPassword', 'toggleNewPasswordIcon');
            setupPasswordToggle('toggleConfirmPassword', 'confirmPassword', 'toggleConfirmPasswordIcon');

            // Auto-dismiss success message
            setTimeout(function() {
                const successAlert = document.querySelector('.alert-success');
                if (successAlert) {
                    const bsAlert = new bootstrap.Alert(successAlert);
                    bsAlert.close();
                }
            }, 5000);

            // Add tooltips to password toggle buttons
            const toggleButtons = document.querySelectorAll('[id^="toggle"]');
            toggleButtons.forEach(btn => {
                btn.title = 'Show password';
                btn.style.cursor = 'pointer';
            });

            // Prevent form submission on Enter key in password fields (to allow validation)
            const passwordFields = [currentPassword, newPassword, confirmPassword];
            passwordFields.forEach(field => {
                field.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        // Move to next field or submit if last field
                        const currentIndex = passwordFields.indexOf(field);
                        if (currentIndex < passwordFields.length - 1) {
                            passwordFields[currentIndex + 1].focus();
                        } else {
                            form.dispatchEvent(new Event('submit', { cancelable: true }));
                        }
                    }
                });
            });

            // Clear validation on page load
            [currentPassword, newPassword, confirmPassword].forEach(field => {
                field.classList.remove('is-valid', 'is-invalid');
            });
        });
    </script>
</body>
</html>